<section class="section" data-controller="vote">
  <div class="columns is-centered">
    <div class="column is-10 has-text-centered">

      <div class="notification has-text-centered">
        <% if @locked %>
          <p>Voting is locked</p>
        <% else %>
          <p>You have <%= distance_of_time_in_words( Time.current, @viewing.datetime - 1.weeks ) %>  left to vote</p>
        <% end %>
      </div>


      <div class="box <%= @vote.new_record? ? 'has-border-danger' : 'has-border-link'%> ">
        <section class="section box">
          <h2 class="subtitle">Your Vote</h2>
          <%= form_with model: @vote do |f| %>
            <%= f.text_field :poll_id, value: @poll.id, class: "is-hidden" %>
            <%= f.text_field :user_id, value: current_user.id, class: "is-hidden" %>
            <div class="field">
              <% @nominations.each do |nomination| %>
                <p>
                  <%= nomination.movie.title %><span data-movie="<%= nomination.movie.id %>">
                    <% case f.object.choices[nomination.movie.id.to_s]
                    when "1" %>
                  - <span class="icon is-small has-text-link"><i class="fas fa-thumbs-up"></i></span>
                <% when "0" %>
                <% when "-1" %>
                  - <span class="icon is-small has-text-danger"><i class="fas fa-thumbs-down"></i></span>
                <% end %>
                  </span>
                  <%= f.text_field "choices[#{nomination.movie.id}]",
                    value: f.object.choices[nomination.movie.id] || 0,
                    data: { movie: nomination.movie.id },
                    class: "is-hidden" %>
                </p>
              <% end %>
            </div>
            <div class="field">
              <div class="control">
                <div class="columns is-centered">
                  <div class="column is-8">
                    <%= f.submit "Vote", class: "button is-large is-link is-fullwidth", disabled: @locked %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </section>

        <section class="section box">
          <% if @poll.movie %>
            <div class="field">
              <h2>Results</h2>
            </div>
            <div class="field">
              <p>The winner is <%= @poll.movie.title %></p>
            </div>
            <%= column_chart @poll.tally.each_with_object({}) { |(key, value), obj| obj[Movie.find(key).title] = value } %>
          <% end %>
        </section>
      </div>
    </div>
  </div>
  <div class="columns is-multiline">
    <%= render partial: @nominations %>
  </div>
</section>
